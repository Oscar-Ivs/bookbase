{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="row g-4">

    <div class="mb-3">
      <!-- Smart back button -->
      {% if book.is_owner %}
        <a href="{% url 'my_collection' %}" class="btn btn-outline-secondary btn-sm">← Back to My Collection</a>
      {% elif book.id %}
        <a href="{% url 'community_list' %}" class="btn btn-outline-secondary btn-sm">← Back to Community</a>
      {% else %}
        <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">← Back Home</a>
      {% endif %}
    </div>

    <!-- Column 1: Cover + Meta -->
    <div class="col-12 col-md-6 col-lg-3 text-center">
      <img src="{{ book.cover_url|default:'/static/img/book-placeholder.png' }}" alt="Book Cover"
           class="img-fluid rounded shadow-sm mb-3"
           style="max-height: 400px; object-fit: contain; background-color: transparent;"
           onerror="this.onerror=null; this.src='/static/img/book-placeholder.png';">

      <h5 class="fw-bold">{{ book.title }}</h5>
      <p class="text-muted">{{ book.author }}</p>

      <!-- Status badge (DB books only) -->
      {% if book.status %}
      <p>
        {% if book.status == 'read' %}
          <span class="badge bg-success">Read</span>
        {% else %}
          <span class="badge bg-danger">Unread</span>
        {% endif %}
      </p>
      {% endif %}

      <!-- Owner-only buttons -->
      {% if book.is_owner %}
      <div class="d-flex justify-content-center gap-2">
        <a href="{% url 'edit_book' book.id %}" class="btn btn-outline-primary btn-sm">Edit</a>
        <a href="{% url 'delete_book' book.id %}" class="btn btn-outline-danger btn-sm">Delete</a>
      </div>
      {% endif %}
    </div>

    <!-- Column 2 & 3 combined for tablet, split on desktop -->
    <div class="col-12 col-md-6 col-lg-9">
      <div class="row g-4">
        <!-- Description -->
        <div class="col-12 col-lg-8">
          <div class="p-3 border rounded" style="background-color: #acbdd8;">
            <h5>Description</h5>
            <p>{{ book.description|default:"No description provided."|safe }}</p>
          </div>
        </div>

        <!-- Notes for DB OR extra details for API -->
        <div class="col-12 col-lg-4">
          <div class="p-3 border rounded" style="background-color: #acbdd8;">
            {% if book.notes %}
              <h5>Notes</h5>
              <p>{{ book.notes }}</p>
            {% else %}
              <h5>Details</h5>
              <p><strong>Publisher:</strong> {{ book.publisher|default:"N/A" }}</p>
              <p><strong>Published:</strong> {{ book.publishedDate|default:"N/A" }}</p>
              <p><strong>Pages:</strong> {{ book.pageCount|default:"N/A" }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% if book.id %}
<hr id="comments">
<h5>Comments</h5>

{% if user.is_authenticated %}
<form method="post" class="mb-3">
  {% csrf_token %}
  <div class="input-group">
    <input type="text" name="comment_text" class="form-control" placeholder="Write a comment…">
    <button class="btn btn-outline-success btn-sm">Post</button>
  </div>
</form>
{% else %}
<div class="alert alert-info py-2 px-3" style="max-width: 520px;">
  Sign in to add a comment.
</div>
{% endif %}

{% if page_obj and page_obj.object_list %}
  {% for c in page_obj %}
  <div class="bb-comment p-3 mb-2 rounded shadow-sm" style="background-color:#acbdd8;">
    <div class="small text-muted mb-1">
      <strong>{{ c.user.username }}</strong> · {{ c.created_at|date:"M j, Y H:i" }}
    </div>

    <div class="d-flex justify-content-between align-items-start gap-2">
      <div>
        {% with full=c.text %}
          {% if full|length > 300 %}
            <span id="short-{{ c.id }}">{{ full|slice:":300" }}…</span>
            <span id="full-{{ c.id }}" class="d-none">{{ full }}</span>
            <button class="btn btn-link btn-sm p-0" data-target="{{ c.id }}" onclick="toggleComment(this)">Read more</button>
          {% else %}
            {{ full }}
          {% endif %}
        {% endwith %}
      </div>

      {% if user.is_authenticated %}
        {% if c.user_id == user.id or book.is_owner %}
          <form method="post" action="{% url 'delete_comment' c.id %}">
            {% csrf_token %}
            <button class="btn btn-outline-danger btn-sm"
                    onclick="return confirm('Are you sure you want to delete this comment?');">
              Delete
            </button>
          </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% endfor %}

  <!-- Pagination -->
  <nav aria-label="Comments pages">
    <ul class="pagination pagination-sm">
      <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
        {% if page_obj.has_previous %}
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}#comments">Previous</a>
        {% else %}
          <span class="page-link">Previous</span>
        {% endif %}
      </li>

      {% for i in page_obj.paginator.page_range %}
        <li class="page-item {% if i == page_obj.number %}active{% endif %}">
          <a class="page-link" href="?page={{ i }}#comments">{{ i }}</a>
        </li>
      {% endfor %}

      <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
        {% if page_obj.has_next %}
          <a class="page-link" href="?page={{ page_obj.next_page_number }}#comments">Next</a>
        {% else %}
          <span class="page-link">Next</span>
        {% endif %}
      </li>
    </ul>
  </nav>

{% else %}
  <p class="text-muted">No comments yet.</p>
{% endif %}
{% endif %}

<script>
  // Expand/collapse long comments
  function toggleComment(btn) {
    const id = btn.getAttribute('data-target');
    const shortEl = document.getElementById('short-' + id);
    const fullEl = document.getElementById('full-' + id);
    const isCollapsed = fullEl.classList.contains('d-none');
    if (isCollapsed) {
      fullEl.classList.remove('d-none');
      shortEl.classList.add('d-none');
      btn.textContent = 'Show less';
    } else {
      fullEl.classList.add('d-none');
      shortEl.classList.remove('d-none');
      btn.textContent = 'Read more';
    }
  }
</script>
{% endblock %}
